<stack:stack>

<stack:description>
	UEFI configuration for SLES machines
</stack:description>

<stack:copyright>
Copyright (c) 2006 - 2017 Teradata
All rights reserved. Stacki(r) v5.x stacki.com
https://github.com/Teradata/stacki/blob/master/LICENSE.txt
</stack:copyright>

<stack:package>mtools</stack:package>
<stack:package>uefi-boot-method</stack:package>

<stack:package stack:cond="'SLES-12-sp2' in &pallets;">grub2-x86_64-efi</stack:package>
<stack:package stack:cond="'SLES-12-sp2' in &pallets;">shim</stack:package>
<stack:package stack:cond="'SLES-12-sp2' in &pallets;">mokutil</stack:package>

<stack:script stack:stage="install-pre">
if [ -d /sys/firmware/efi ]; then
	netboot=`efibootmgr | awk '/^BootCurrent:/{print $2;}'`
	[ ! -z $netboot ] &amp;&amp; echo $netboot > /tmp/uefi_netboot
fi
</stack:script>

<stack:script stack:stage="install-post" stack:chroot="false">
if [ -f /tmp/uefi_netboot ]; then
	mkdir -p /mnt/opt/stack/etc/
	mv /tmp/uefi_netboot /mnt/opt/stack/etc/uefi_netboot
fi
</stack:script>

<stack:script stack:stage="install-post" stack:shell="python" stack:chroot="false">
<![CDATA[
import os
import sys
import subprocess

efi_dev = None
mtab = open('/etc/mtab','r')
for mountline in mtab.readlines():
	m = mountline.split()
	if m[1].strip() == '/mnt/boot/efi':
		efi_dev = m[0].strip()
		break

if efi_dev:
	f = open('/mnt/etc/mtools.conf','a')
	f.write('\ndrive x: file="%s"\n' % efi_dev)
	f.close()
]]>
</stack:script>

<stack:script stack:cond="'SLES-12-sp2' in &pallets;" stack:stage="install-post">
/usr/bin/mlabel x:BOOTEFI
</stack:script>

<stack:script stack:cond="'SLES-11.3-1.138' in &pallets;" stack:stage="install-post" stack:chroot="false">
MTOOLSRC=/mnt/etc/mtools.conf /mnt/usr/bin/mlabel x:BOOTEFI
</stack:script>

<stack:script stack:stage="boot-post">
systemctl enable uefi-boot-method
systemctl start uefi-boot-method
</stack:script>

</stack:stack>
